<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Keywords Overview</title>
    <!-- 
    <link rel="stylesheet" type="text/css" href="//cdn.datatables.net/1.10.20/css/jquery.dataTables.min.css">
     -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.12.1/datatables.min.css"/>
</head>

<body>
    <h4>Keyword</h4>
    <table id="keyword" class="display" style="width:100%">
        <thead>
            <tr>
            	<th>Id</th>
                <th>K-Id</th>
                <th>Lang</th>
                <th>Keyword text</th>
                <th>Keyword (EN)</th>
                <th>Pref Label (EN)</th>
                <th>Pref-WKD ID</th>
                <th>Validation  </th>
                <th>Status</th>
                <th>TP Items</th>
                <!-- 
                <th>Type</th>
                 -->
                <!-- 
                <th>Position</th>
                 -->
                <th>Wikidata Types</th>
                <th>Spotlight WKD Ids</th>
                <th>Alternative WKD Ids</th>
                <!-- 
                <th>Dbpedia ID</th>
                <th>Dbpedia-WKD ID</th>
                
                <th>WKD IDs</th>
                <th>WKD Alt IDs</th>
                 -->
            </tr>
        </thead>
        <tfoot>
            <tr>
            	<th>objectId</th>
                <th>propertyId</th>
                <th>detectedOriginalLanguage</th>
                <th>value</th>
                <th>translatedValue</th>
                <th>prefLabelEn</th>
                <th>preferredWikidataId</th>
                <th>validation</th>
                <th>status</th>
                <th>tpItemIds</th>
                <!--  
                <th>Type</th>
                -->
                 <!-- 
                <th>Position</th>
                 -->
                <th>WikidataTypes</th>
                <th>dbpediaWikidataIds</th>
                <th>wikidataLabelAltLabelMatchIds</th>
                <!-- 
                <th>Dbp_ID</th>
                <th>DbpWKD_ID</th>
                
                <th>WKD_IDs</th>
                <th>WKD_AltLabel_IDs</th>
                 -->
            </tr>
        </tfoot>
    </table>

    
    <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <script src="jquery.spring-friendly.js"></script>
    <!--  script src="//cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script -->
    <script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.12.1/datatables.min.js"></script>
    

    <script type="text/javascript">

    	function getDbpLink(url){
    		if(url){
    			return '<a href="' + url + '" target="_blank">'+ url.replace('http://dbpedia.org/resource/', '') + '</a>';
    		}
    		return ''; 
    	}
    
    	function approve(objectId, prefWkdId){
    		//alert('approve: ' + objectId);
    		let confirmed = confirm("Approve wikidata entity " + prefWkdId + " for keyword", prefWkdId);
    		//alert('Confirmed ' + objectId  + ' - ' + confirmed);
    		if(confirmed){
    			$.ajax({
    				  url: "keyword/approve?objectId=" + objectId,
    				})
    				  .done(function( data ) {
    					  alert("update operation succeded! ");
    					  $('#keyword').DataTable().ajax.reload();
    				  })
    				  .fail(function( data ) {
    				    alert("update operation failed: " + data);
    				    console.log(data);
    				  })
    		}
    	}
    	
    	function approveAlternative(objectId, prefWkdId){
    		//alert('approve: ' + objectId);
    		let confirmed = prompt("Assign alternative wikidata entity for keyword", "Enter an alternativive Wikidata id (e.g. Q1234)");
    		//alert('Confirmed ' + objectId  + ' - ' + confirmed);
    		if(confirmed){
    			$.ajax({
    				  url: "keyword/approve/alternative?objectId=" + objectId + "&wkdId=" + confirmed,
    				})
    				  .done(function( data ) {
    					  alert("update operation succeded! ");
    					  $('#keyword').DataTable().ajax.reload();
    				  })
    				  .fail(function( data ) {
    				    alert("update operation failed: " + data);
    				    console.log(data);
    				  })
    		}
    	}
    	
    	function approveBroad(objectId, prefWkdId){
    		//alert('approve: ' + objectId);
    		let confirmed = prompt("Approve wikidata entity " + prefWkdId + " or provide alternative entity (e.g. Q1234) as broad match for keyword", prefWkdId);
    		//alert('Confirmed ' + objectId  + ' - ' + confirmed);
    		if(confirmed){
    			$.ajax({
    				  url: "keyword/approve/broad?objectId=" + objectId + "&wkdId=" + confirmed,
    				})
    				  .done(function( data ) {
    					  alert("update operation succeded! ");
    					  $('#keyword').DataTable().ajax.reload();
    				  })
    				  .fail(function( data ) {
    				    alert("update operation failed: " + data.error);
    				    console.log(data);
    				  })
    		}
    	}
    	
    	function reject(objectId, prefWkdId){
    		let confirmed = confirm("Confirm rejection of keyword to wikidata entity linking: " + prefWkdId);
    		//alert('Confirmed ' + objectId  + ' - ' + confirmed);
    		if(confirmed){
    			$.ajax({
    				  url: "keyword/reject?objectId=" + objectId,
    				})
    				  .done(function( data ) {
    					  alert("update operation succeded!");
    					  $('#keyword').DataTable().ajax.reload();
    				  })
    				  .fail(function( data ) {
    				    alert("update operation failed: " + data);
    				    console.log(data);
    				  })
    		}
    	}
    	
    	function buildButtons(objectId, prefWkdId){
    		var links = '<a href="javascript:" onclick="approve(\''+objectId+'\', \''+prefWkdId+'\')"><img src="./img/approve1.png" height="18" /></a>';
    		links = links + ' <a href="javascript:" onclick="reject(\''+objectId+'\', \''+prefWkdId+'\')"><img src="./img/reject1.png" height="18" /></a>';
    		links = links + ' <a href="javascript:" onclick="approveAlternative(\''+objectId+'\', \''+prefWkdId+'\')"><img src="./img/change1.png" height="18" /></a>';
    		links = links + ' <a href="javascript:" onclick="approveBroad(\''+objectId+'\', \''+prefWkdId+'\')"><img src="./img/broader1.png" height="18" /></a>';
    		return links	 
    	}
    	
    	function getWkdLink(url){
    		if(url){
    			return '<a href="' + url + '" target="_blank">'+ url.replace('http://www.wikidata.org/entity/', '') + '</a>';
    		}
    		return ''; 
    	}
    	
    	function getTpLink(tpItemId){
    		if(tpItemId){
    			//https://europeana.transcribathon.eu/documents/story/item/?item=451984
    			return '<a href="https://europeana.transcribathon.eu/documents/story/item/?item=' + tpItemId + '" target="_blank">'+ tpItemId + '</a>';
    		}
    		return ''; 
    	}
    	
    	function getValue(dataObject, attributeName){
    		if(dataObject && dataObject[attributeName]){
    			return dataObject[attributeName];
    		}
    		return ''; 
    	}

    	function buildTpLinks(tpItemIds){
    		if(tpItemIds){
    			res = '';
    			for (let i = 0; i < tpItemIds.length; i++){
    				 res += getTpLink(tpItemIds[i]);
    				 res += ", ";
    			}
    			return res;
    		}
    		return ''; 
    	}
    	
    	function buildWkdLinks(urls){
    		if(urls){
    			res = '';
    			for (let i = 0; i < urls.length; i++){
    				 res += getWkdLink(urls[i]);
    				 res += ", ";
    			}
    			return res;
    		}
    		return ''; 
    	}
    	
    	function getWkdLinks(data){
    		if(data){
    			urls = data.split(',');
    			res = '';
    			 for (let i = 0; i < urls.length; i++){
    				 res += getWkdLink(urls[i]);
    				 res += ", ";
    			 }
    			return res;
    		}
    		return ''; 
    	}
    	
    	function buildStatus(status, approvedWkdId){
    		if('approved_alternative' == status || 'approved_broad_match' == status){
    			return status + ' (' + getWkdLink(approvedWkdId) + ')'; 
    		} else {
    			return '' + status;
    		} 
    	}
    	
        $(document).ready(function() {
        	//display search boxes only on selected cplumns
            $('#keyword tfoot th').each( function () {
                var title = $(this).text();
                if(title != "objectId" && title != "prefLabelEn" && title != "validation" && title != "tpItemIds" && title != "WikidataTypes"){
                	$(this).html( '<input type="text" placeholder="Search '+title+'" />' );
                }else{
                	$(this).html( '&nbsp;' );
                }
            } );

        	//fetch the data throug ajax call
            var table = $('#keyword').DataTable( {
                processing: false,
                serverSide: true,
                searching: true,
                order: [[1, 'asc']],
                columnDefs: [
                    { "width": "5%", "targets": 1 }
                  ],
                ajax: {
                    url: "keyword/datatable",
                    dataSrc: function (data) {
                        let renderData = new Array();
						//render the data into the column, and apply transformations where needed	
                        for (let i = 0; i < data.data.length; i++) {
                            renderData.push({
                            	objectId: data.data[i].objectId,
                                propertyId: data.data[i].propertyId,
                                detectedOriginalLanguage: data.data[i].detectedOriginalLanguage, 
                                value: data.data[i].value,
                                translatedValue: data.data[i].translatedValue,
                                prefLabelEn: getValue(data.data[i], 'prefLabelEn'),
                                preferredWikidataId: getWkdLink(data.data[i].preferredWikidataId),
                                //add the action buttons
                                validation: buildButtons(data.data[i].objectId, data.data[i].preferredWikidataId),
                                status: buildStatus (data.data[i].status, data.data[i].approvedWikidataId),
                                tpItemIds: buildTpLinks(data.data[i].tpItemIds),
                                //Type: getValue(data.data[i], 'type'),
                                //Position: data.data[i].position,
                                WikidataTypes: '' + data.data[i].wikidataTypes,
                                dbpediaWikidataIds: buildWkdLinks(data.data[i].dbpediaWikidataIds),
                                wikidataLabelAltLabelMatchIds: buildWkdLinks(data.data[i].wikidataLabelAltLabelMatchIds),
                            });
                        }

                        return renderData;
                    }
                },
                //column display definitions && column controls
                columns: [
                	{ data: 'objectId', width: '5%' },
                    { data: 'propertyId' , width: '5%'},
                    { data: 'detectedOriginalLanguage' },
                    { data: 'value', name: 'value'},
                    { data: 'translatedValue' },
                    { data: 'prefLabelEn', searchable: true, orderable: false},
                    { data: 'preferredWikidataId', searchable: true, orderable: false},
                    { data: 'validation', searchable: false, orderable: false},
                    { data: 'status' },
                    { data: 'tpItemIds', searchable: true, orderable: false },
                    { data: 'WikidataTypes', name: 'WikidataTypes', searchable: false, orderable: false},
                    { data: 'dbpediaWikidataIds', searchable: true, orderable: false },
                    { data: 'wikidataLabelAltLabelMatchIds', searchable: true, orderable: false },
                ]
            } );

            //trigger the search function automatically
        	table.columns().every( function () {
                var that = this;

                $( 'input', this.footer() ).on( 'keyup change clear', function () {
                    if ( that.search() !== this.value ) {
                        that
                            .search( this.value )
                            .draw();
                    }
                } );
            } );
        } );
        

    </script>
</body>

</html>